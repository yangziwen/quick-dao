<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用手册 | QuickDAO 项目文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="对Spring JDBC, MyBatis, sql2o等orm框架进行封装和抽象，用于快速实现增删改查功能">
    
    <link rel="preload" href="/quick-dao/assets/css/0.styles.d6989401.css" as="style"><link rel="preload" href="/quick-dao/assets/js/app.ad0dd564.js" as="script"><link rel="preload" href="/quick-dao/assets/js/2.cfc2b85d.js" as="script"><link rel="preload" href="/quick-dao/assets/js/8.1fd11c31.js" as="script"><link rel="prefetch" href="/quick-dao/assets/js/3.577fed74.js"><link rel="prefetch" href="/quick-dao/assets/js/4.b02c579a.js"><link rel="prefetch" href="/quick-dao/assets/js/5.3285f7a8.js"><link rel="prefetch" href="/quick-dao/assets/js/6.2f1becd6.js"><link rel="prefetch" href="/quick-dao/assets/js/7.a0bd7795.js"><link rel="prefetch" href="/quick-dao/assets/js/9.be335660.js">
    <link rel="stylesheet" href="/quick-dao/assets/css/0.styles.d6989401.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/quick-dao/" class="home-link router-link-active"><!----> <span class="site-name">QuickDAO 项目文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/quick-dao/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/quick-dao/start/index.html" class="nav-link">
  快速开始
</a></div><div class="nav-item"><a href="/quick-dao/manual/index.html" class="nav-link">
  使用手册
</a></div><div class="nav-item"><a href="https://github.com/yangziwen/quick-dao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/quick-dao/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/quick-dao/start/index.html" class="nav-link">
  快速开始
</a></div><div class="nav-item"><a href="/quick-dao/manual/index.html" class="nav-link">
  使用手册
</a></div><div class="nav-item"><a href="https://github.com/yangziwen/quick-dao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/quick-dao/start/" class="sidebar-link">快速开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/start/#简介" class="sidebar-link">简介</a></li><li class="sidebar-sub-header"><a href="/quick-dao/start/#引入依赖" class="sidebar-link">引入依赖</a></li><li class="sidebar-sub-header"><a href="/quick-dao/start/#定义数据实体类" class="sidebar-link">定义数据实体类</a></li><li class="sidebar-sub-header"><a href="/quick-dao/start/#实现数据访问类" class="sidebar-link">实现数据访问类</a></li><li class="sidebar-sub-header"><a href="/quick-dao/start/#使用java-dsl构造sql" class="sidebar-link">使用Java DSL构造SQL</a></li></ul></li><li><a href="/quick-dao/manual/" aria-current="page" class="active sidebar-link">使用手册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/manual/#构建数据访问类" class="sidebar-link">构建数据访问类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/manual/#引入依赖" class="sidebar-link">引入依赖</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#声明实体类" class="sidebar-link">声明实体类</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#实现数据访问类" class="sidebar-link">实现数据访问类</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#添加个性化方法" class="sidebar-link">添加个性化方法</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#配置字段包装符号" class="sidebar-link">配置字段包装符号</a></li></ul></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#修改操作" class="sidebar-link">修改操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/manual/#插入数据" class="sidebar-link">插入数据</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#更新数据" class="sidebar-link">更新数据</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#删除数据" class="sidebar-link">删除数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#查询操作" class="sidebar-link">查询操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/manual/#按id查询结果" class="sidebar-link">按id查询结果</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#查询单个结果" class="sidebar-link">查询单个结果</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#查询列表结果" class="sidebar-link">查询列表结果</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#查询数量结果" class="sidebar-link">查询数量结果</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#查询分页结果" class="sidebar-link">查询分页结果</a></li></ul></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#构造查询条件" class="sidebar-link">构造查询条件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/quick-dao/manual/#简单查询条件" class="sidebar-link">简单查询条件</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#复杂查询条件" class="sidebar-link">复杂查询条件</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#聚合查询条件" class="sidebar-link">聚合查询条件</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#嵌套查询条件" class="sidebar-link">嵌套查询条件</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#基于断言的查询条件" class="sidebar-link">基于断言的查询条件</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#条件比较运算符" class="sidebar-link">条件比较运算符</a></li></ul></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#使用数据库函数" class="sidebar-link">使用数据库函数</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#如何处理枚举" class="sidebar-link">如何处理枚举</a></li><li class="sidebar-sub-header"><a href="/quick-dao/manual/#逻辑删除的实现" class="sidebar-link">逻辑删除的实现</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用手册"><a href="#使用手册" class="header-anchor">#</a> 使用手册</h1> <h2 id="构建数据访问类"><a href="#构建数据访问类" class="header-anchor">#</a> 构建数据访问类</h2> <p>基于实体类的泛型声明，QuickDAO的数据访问类(<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-spring-jdbc/src/main/java/io/github/yangziwen/quickdao/springjdbc/BaseSpringJdbcRepository.java" target="_blank" rel="noopener noreferrer">BaseRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)为用户提供了基本的增删改查功能。在使用时，用户可以根据自身的需要，选用基于不同ORM框架的封装实现。</p> <p>下面以基于Spring JDBC封装的<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-spring-jdbc/src/main/java/io/github/yangziwen/quickdao/springjdbc/BaseSpringJdbcRepository.java" target="_blank" rel="noopener noreferrer">BaseSpringJdbcRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>为例，说明如何构建指定实体类的数据访问类。</p> <h3 id="引入依赖"><a href="#引入依赖" class="header-anchor">#</a> 引入依赖</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.yangziwen<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>quick-dao-spring-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.21<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="声明实体类"><a href="#声明实体类" class="header-anchor">#</a> 声明实体类</h3> <p>注意，使用<code>@Table</code>修饰的实体和使用<code>@Column</code>修饰的字段，才会被QuickDAO使用。<br>
数据库的表名、字段名默认由实体类的类名、字段名按驼峰法转下划线法获得，也可以在<code>@Table</code>和<code>@Column</code>注解中显式指定。<br>
可通过添加<code>@GeneratedValue</code>注解实现基于数据库主键自增的id，否则需要在插入数据前手动填充id（例如使用snowflake生成全局唯一id的场景）。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">Gender</span> gender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="实现数据访问类"><a href="#实现数据访问类" class="header-anchor">#</a> 实现数据访问类</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">BaseSpringJdbcRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token class-name">UserRepository</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>UserRepository</code>类即可针对<code>User</code>实体类为用户提供基本的增删改查和分页查询的功能。<br></p> <p>其中<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-spring-jdbc/src/main/java/io/github/yangziwen/quickdao/springjdbc/BaseSpringJdbcReadOnlyRepository.java" target="_blank" rel="noopener noreferrer">BaseSpringJdbcReadOnlyRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口的实现类中包含以下查询方法以及各种变体</p> <ul><li>getById</li> <li>first</li> <li>list</li> <li>listByIds</li> <li>count</li> <li>paginate</li></ul> <p>而<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-spring-jdbc/src/main/java/io/github/yangziwen/quickdao/springjdbc/BaseSpringJdbcRepository.java" target="_blank" rel="noopener noreferrer">BaseSpringJdbcRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口的实现类中不仅包含上述的查询方法，还包含以下的增删改操作</p> <ul><li>insert</li> <li>batchInsert</li> <li>update</li> <li>updateSelective</li> <li>delete</li> <li>deleteById</li> <li>deleteByIds</li></ul> <p>在<code>UserRepository</code>类上添加<code>@Repository</code>注解，同时在构造方法上添加<code>@Autowired</code>注解，即可将数据访问类的实例托管给Spring容器维护。</p> <h3 id="添加个性化方法"><a href="#添加个性化方法" class="header-anchor">#</a> 添加个性化方法</h3> <p>建议将查询条件的构造过程实现在数据访问类中，对外仅暴露语义明确的方法，尽量不要将构造查询条件的过程泄漏到数据访问层以外。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">BaseSpringJdbcRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">UserRepository</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">listByUsernameStartWith</span><span class="token punctuation">(</span><span class="token class-name">String</span> usernamePrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">listCriteria</span><span class="token punctuation">(</span>criteria <span class="token operator">-&gt;</span> criteria
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">:</span>getUsername<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span>usernamePrefix<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="配置字段包装符号"><a href="#配置字段包装符号" class="header-anchor">#</a> 配置字段包装符号</h3> <p>当数据表中存在一些与数据库关键字同名的字段时，则需要使用字段包装符号，才能正常操作这些字段。例如</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>order<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>group<span class="token punctuation">`</span></span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>data<span class="token punctuation">`</span></span> <span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>order<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre></div><p>对于不同的数据库，字段包装符号会有所不同。</p> <p>例如MySQL数据库的字段包装符号如下</p> <table><thead><tr><th style="text-align:center;">字段类型</th> <th style="text-align:center;">包装符号</th> <th style="text-align:center;">示例</th></tr></thead> <tbody><tr><td style="text-align:center;">表名</td> <td style="text-align:center;">``</td> <td style="text-align:center;"><code>SELECT * FROM `user`</code></td></tr> <tr><td style="text-align:center;">字段名</td> <td style="text-align:center;">``</td> <td style="text-align:center;"><code>SELECT `username` FROM `user`</code></td></tr> <tr><td style="text-align:center;">别名</td> <td style="text-align:center;">''</td> <td style="text-align:center;"><code>SELECT `username` AS 'name' FROM `user`</code></td></tr></tbody></table> <p>对于不同ORM框架，变量占位符的包装符号也会有所不同。</p> <p>例如Spring JDBC的变量占位符是<code>:username</code>的形式，而Mybatis的变量占位符是<code>#{username}</code>的形式。</p> <p>这就要求我们在声明数据访问类时，能够定制化的配置这些字段包装符号。</p> <p>仍以MySQL和Spring JDBC的组合为例，可按如下方式声明字段的包装符号。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">BaseSpringJdbcRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">UserRepository</span><span class="token punctuation">(</span><span class="token class-name">DataSource</span> dataSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JdbcTemplate</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SqlGenerator</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">StringWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;`&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;`&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">StringWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;`&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;`&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">StringWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">StringWrapper</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>包装符号的配置，是通过显式的调用<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/SqlGenerator.java" target="_blank" rel="noopener noreferrer">SqlGenerator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的以下构造方法实现的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">SqlGenerator</span><span class="token punctuation">(</span>
        <span class="token class-name">StringWrapper</span> tableWrapper<span class="token punctuation">,</span>
        <span class="token class-name">StringWrapper</span> columnWrapper<span class="token punctuation">,</span>
        <span class="token class-name">StringWrapper</span> aliasWrapper<span class="token punctuation">,</span>
        <span class="token class-name">StringWrapper</span> placeholderWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tableWrapper <span class="token operator">=</span> tableWrapper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>columnWrapper <span class="token operator">=</span> columnWrapper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>aliasWrapper <span class="token operator">=</span> aliasWrapper<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>placeholderWrapper <span class="token operator">=</span> placeholderWrapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="修改操作"><a href="#修改操作" class="header-anchor">#</a> 修改操作</h2> <p><a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/BaseRepository.java" target="_blank" rel="noopener noreferrer">BaseRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口的实现类中提供了以下修改数据的方法</p> <h3 id="插入数据"><a href="#插入数据" class="header-anchor">#</a> 插入数据</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 插入一条记录，并回填id</span>
<span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">E</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 插入多条记录（方法内部会执行集合的判空操作）</span>
<span class="token keyword">void</span> <span class="token function">batchInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 插入多条记录，并按指定数值分批次插入</span>
<span class="token keyword">void</span> <span class="token function">batchInsert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> entities<span class="token punctuation">,</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">E</td> <td style="text-align:center;">entity</td> <td style="text-align:center;">实体对象</td></tr> <tr><td style="text-align:center;">List&lt;E&gt;</td> <td style="text-align:center;">entities</td> <td style="text-align:center;">实体对象集合</td></tr> <tr><td style="text-align:center;">int</td> <td style="text-align:center;">batchSize</td> <td style="text-align:center;">插入批次数量</td></tr></tbody></table> <h3 id="更新数据"><a href="#更新数据" class="header-anchor">#</a> 更新数据</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按entity中的主键id更新一条记录，主键字段由@Id注解指定</span>
<span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">E</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按entity中的主键id更新一条记录，仅会更新entity中的非空字段</span>
<span class="token keyword">void</span> <span class="token function">updateSelective</span><span class="token punctuation">(</span><span class="token class-name">E</span> entity<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件更新多条记录，且仅会更新entity中的非空字段</span>
<span class="token keyword">void</span> <span class="token function">updateSelective</span><span class="token punctuation">(</span><span class="token class-name">E</span> entity<span class="token punctuation">,</span> <span class="token class-name">Criteria</span> criteria<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件更新多条记录，且仅会更新entity中的非空字段</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造过滤条件</span>
<span class="token keyword">void</span> <span class="token function">updateSelective</span><span class="token punctuation">(</span><span class="token class-name">E</span> entity<span class="token punctuation">,</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">E</td> <td style="text-align:center;">entity</td> <td style="text-align:center;">实体对象</td></tr> <tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">过滤条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造过滤条件的函数式接口</td></tr></tbody></table> <h3 id="删除数据"><a href="#删除数据" class="header-anchor">#</a> 删除数据</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按主键id删除一条记录</span>
<span class="token keyword">void</span> <span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token class-name">Object</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按主键id集合删除多条数据</span>
<span class="token keyword">void</span> <span class="token function">deleteByIds</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件删除数据</span>
<span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span> criteria<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件删除数据</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造过滤条件</span>
<span class="token keyword">void</span> <span class="token function">deleteCriteria</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件删除数据，用于支持需要设定limit的情形</span>
<span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按过滤条件删除数据，用于支持需要设定limit的情形</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedQuery对象，用于构造过滤条件</span>
<span class="token keyword">void</span> <span class="token function">deleteQuery</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedQuery</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">Object</td> <td style="text-align:center;">id</td> <td style="text-align:center;">主键id</td></tr> <tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">过滤条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造过滤条件的函数式接口</td></tr> <tr><td style="text-align:center;">Query</td> <td style="text-align:center;">query</td> <td style="text-align:center;">过滤条件，支持limit参数</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedQuery&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造过滤条件的函数式接口</td></tr></tbody></table> <h2 id="查询操作"><a href="#查询操作" class="header-anchor">#</a> 查询操作</h2> <p><a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/BaseRepository.java" target="_blank" rel="noopener noreferrer">BaseRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口和<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/BaseReadOnlyRepository.java" target="_blank" rel="noopener noreferrer">BaseReadOnlyRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口的实现类中提供了以下查询数据的方法</p> <h3 id="按id查询结果"><a href="#按id查询结果" class="header-anchor">#</a> 按id查询结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按主键id查询一条记录</span>
<span class="token class-name">E</span> <span class="token function">getById</span><span class="token punctuation">(</span><span class="token class-name">Object</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按主键id集合查询多条数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">listByIds</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">Object</td> <td style="text-align:center;">id</td> <td style="text-align:center;">主键id</td></tr> <tr><td style="text-align:center;">Collection&lt;?&gt;</td> <td style="text-align:center;">ids</td> <td style="text-align:center;">主键id集合</td></tr></tbody></table> <h3 id="查询单个结果"><a href="#查询单个结果" class="header-anchor">#</a> 查询单个结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按条件查询单条数据</span>
<span class="token class-name">E</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span> criteria<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询单条数据</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造查询条件</span>
<span class="token class-name">E</span> <span class="token function">firstCriteria</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询单条数据，并支持聚合、排序等前提要求</span>
<span class="token class-name">E</span> <span class="token function">first</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询单条数据，并支持聚合、排序等前提要求</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedQuery对象，用于构造查询条件</span>
<span class="token class-name">E</span> <span class="token function">firstQuery</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedQuery</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">查询条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr> <tr><td style="text-align:center;">Query</td> <td style="text-align:center;">query</td> <td style="text-align:center;">查询条件，支持<code>group by</code>和<code>having</code>操作</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedQuery&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr></tbody></table> <h3 id="查询列表结果"><a href="#查询列表结果" class="header-anchor">#</a> 查询列表结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按条件查询多条数据</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span> criteria<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询多条数据</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造查询条件</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">listCriteria</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询单条数据，并支持聚合、排序等前提要求</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询单条数据，并支持聚合、排序等前提要求</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedQuery对象，用于构造查询条件</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">listQuery</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedQuery</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">查询条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr> <tr><td style="text-align:center;">Query</td> <td style="text-align:center;">query</td> <td style="text-align:center;">查询条件，支持<code>group by</code>和<code>having</code>操作</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedQuery&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr></tbody></table> <h3 id="查询数量结果"><a href="#查询数量结果" class="header-anchor">#</a> 查询数量结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按条件查询数量</span>
<span class="token class-name">Integer</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span> criteria<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询数量</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造查询条件</span>
<span class="token class-name">Integer</span> <span class="token function">countCriteria</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询数量，并支持聚合等前提要求</span>
<span class="token class-name">Integer</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询数量，并支持聚合等前提要求</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedQuery对象，用于构造查询条件</span>
<span class="token class-name">Integer</span> <span class="token function">countQuery</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedQuery</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">查询条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr> <tr><td style="text-align:center;">Query</td> <td style="text-align:center;">query</td> <td style="text-align:center;">查询条件，支持<code>group by</code>和<code>having</code>操作</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedQuery&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr></tbody></table> <h3 id="查询分页结果"><a href="#查询分页结果" class="header-anchor">#</a> 查询分页结果</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 按条件查询分页结果</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">paginate</span><span class="token punctuation">(</span><span class="token class-name">Criteria</span> criteria<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询分页结果</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedCriteria对象，用于构造查询条件</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">paginateCriteria</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedCriteria</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询分页结果，并支持聚合等要求</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">paginate</span><span class="token punctuation">(</span><span class="token class-name">Query</span> query<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 按条件查询分页结果，并支持聚合等前提要求</span>
<span class="token comment">// 方法内部会向consumer入参注入一个TypedQuery对象，用于构造查询条件</span>
<span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span></span> <span class="token function">paginateQuery</span><span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypedQuery</span><span class="token punctuation">&lt;</span><span class="token class-name">E</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">,</span> <span class="token keyword">int</span> pageNo<span class="token punctuation">,</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>参数说明</p> <table><thead><tr><th style="text-align:center;">类型</th> <th style="text-align:center;">参数名</th> <th style="text-align:center;">描述</th></tr></thead> <tbody><tr><td style="text-align:center;">int</td> <td style="text-align:center;">pageNo</td> <td style="text-align:center;">当前页号，从1开始计数</td></tr> <tr><td style="text-align:center;">int</td> <td style="text-align:center;">pageSize</td> <td style="text-align:center;">每页数据条数</td></tr> <tr><td style="text-align:center;">Criteria</td> <td style="text-align:center;">criteria</td> <td style="text-align:center;">查询条件</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedCriteria&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr> <tr><td style="text-align:center;">Query</td> <td style="text-align:center;">query</td> <td style="text-align:center;">查询条件，支持<code>group by</code>和<code>having</code>操作</td></tr> <tr><td style="text-align:center;">Consumer&lt;TypedQuery&lt;E&gt;&gt;</td> <td style="text-align:center;">consumer</td> <td style="text-align:center;">用于构造查询条件的函数式接口</td></tr></tbody></table> <h2 id="构造查询条件"><a href="#构造查询条件" class="header-anchor">#</a> 构造查询条件</h2> <p>QuickDAO基于Java DSL构造查询语句，其中<code>Criteria</code>对象（包括<code>TypedCriteria</code>）代表<code>WHERE</code>和<code>HAVING</code>后的一系列过滤条件，而<code>Query</code>对象（包括<code>TypedQuery</code>）代表整个SQL语句，可指定<code>SELECT</code>的字段、<code>GROUP BY</code>的字段、<code>ORDER BY</code>的方式、<code>LIMIT</code>的限制，以及为<code>WHERE</code>和<code>HAVING</code>设置相应的<code>Criteria</code>对象。
<br> <br>
在编写Java DSL的过程中，用户可以选择使用字符串来声明字段，也可以基于getter方法的lambda表达式来声明字段。<br></p> <ul><li>使用字符串声明字段时，既可以使用数据库表中的原始字段名，也可以使用Java实体类中的字段名，同时还可以在<code>Query</code>对象的<code>select</code>方法中使用各种数据库函数。当使用Java实体类中的字段名编写DSL时，QuickDAO会自动完成向数据库表中原始字段名的转换。<br></li> <li>使用基于getter方法的lambda表达式声明字段时，QuickDAO会根据<code>TypedCriteria</code>或者<code>TypedQuery</code>对象声明的泛型，对lambda表达式进行编译期检查，可有效避免DSL中的字段声明错误。<code>TypedQuery</code>对象暴露了<code>selectExpr</code>方法，也可以支持少数常用数据库函数结合这种lambda表达式的形式进行调用。</li></ul> <h3 id="简单查询条件"><a href="#简单查询条件" class="header-anchor">#</a> 简单查询条件</h3> <p>当SQL中仅需要指定<code>WHERE</code>后的查询条件时，可直接使用<code>Criteria</code>对象编写DSL</p> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;email&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endWith</span><span class="token punctuation">(</span><span class="token string">&quot;@qq.com&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedCriteria</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getEmail</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endWith</span><span class="token punctuation">(</span><span class="token string">&quot;@qq.com&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上DSL会生成如下SQL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'username'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'gender'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'age'</span>
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span>
<span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span> <span class="token operator">LIKE</span> <span class="token string">'%@qq.com'</span>
  <span class="token operator">AND</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token operator">&gt;=</span> <span class="token number">20</span>
  <span class="token operator">AND</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token operator">&lt;=</span> <span class="token number">30</span>
</code></pre></div><h3 id="复杂查询条件"><a href="#复杂查询条件" class="header-anchor">#</a> 复杂查询条件</h3> <p>当SQL中需要指定查询字段、聚合方式、排序方式等条件时，需要使用<code>Query</code>对象编写DSL</p> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span>criteria <span class="token operator">-&gt;</span> criteria
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">,</span> <span class="token class-name">Direction</span><span class="token punctuation">.</span><span class="token constant">DESC</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上DSL会生成如下SQL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'username'</span>
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span>
<span class="token keyword">WHERE</span> <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">DESC</span>
<span class="token keyword">LIMIT</span> <span class="token number">10</span>
</code></pre></div><p>枚举类Gender在声明时实现了<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/IEnum.java" target="_blank" rel="noopener noreferrer">IEnum<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口，可以参见<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-example/src/main/java/io/github/yangziwen/quickdao/example/enums/Gender.java" target="_blank" rel="noopener noreferrer">Gender<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h3 id="聚合查询条件"><a href="#聚合查询条件" class="header-anchor">#</a> 聚合查询条件</h3> <p><code>Query</code>对象对聚合查询也提供了支持</p> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;avg(`age`) AS 'age'&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;min(`age`)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">selectExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span>criteria <span class="token operator">-&gt;</span> criteria<span class="token punctuation">.</span><span class="token function">andExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上DSL会生成如下SQL</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
  <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">AS</span> <span class="token string">'gender'</span><span class="token punctuation">,</span>
  <span class="token function">AVG</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">'age'</span>
<span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span>
<span class="token keyword">HAVING</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>avg<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">20</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token identifier"><span class="token punctuation">`</span>GENDER<span class="token punctuation">`</span></span>
</code></pre></div><h3 id="嵌套查询条件"><a href="#嵌套查询条件" class="header-anchor">#</a> 嵌套查询条件</h3> <p>有些情况下，<code>WHERE</code>中的各种<code>AND</code>和<code>OR</code>的条件可能会涉及嵌套，可按如下方式编写DSL。</p> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;张&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;李&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">FEMALE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedCriteria</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;张&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">MALE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;李&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Gender</span><span class="token punctuation">.</span><span class="token constant">FEMALE</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上DSL会生成如下查询条件</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">LIKE</span> <span class="token string">'张%'</span> <span class="token operator">AND</span> gender <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">OR</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">LIKE</span> <span class="token string">'李%'</span> <span class="token operator">AND</span> gender <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>同样的，也可以在<code>AND</code>中嵌套<code>OR</code>条件，例如</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;张&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startWith</span><span class="token punctuation">(</span><span class="token string">&quot;李&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上述DSL会生成如下查询条件</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">WHERE</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">LIKE</span> <span class="token string">'张%'</span> <span class="token operator">OR</span> <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token operator">LIKE</span> <span class="token string">'李%'</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token operator">&lt;=</span> <span class="token number">20</span> <span class="token operator">OR</span> <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token operator">&gt;=</span> <span class="token number">30</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="基于断言的查询条件"><a href="#基于断言的查询条件" class="header-anchor">#</a> 基于断言的查询条件</h3> <p>QuickDAO还提供了基于断言的查询条件构造方式，在保持链式的DSL的前提下，提供了动态控制查询条件拼装的能力。</p> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">Criteria</span> <span class="token function">toCriteria</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Integer</span> minAge<span class="token punctuation">,</span> <span class="token class-name">Integer</span> maxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contain</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span>minAge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span>minAge<span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span>maxAge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">TypedCriteria</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">toCriteria</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> <span class="token class-name">Integer</span> minAge<span class="token punctuation">,</span> <span class="token class-name">Integer</span> maxAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TypedCriteria</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getUsername</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contain</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> minAge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span>minAge<span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">ifValid</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> maxAge <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span>maxAge<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="条件比较运算符"><a href="#条件比较运算符" class="header-anchor">#</a> 条件比较运算符</h3> <p>上述构造<code>Criteria</code>条件的过程中，使用了各种比较运算符。QuickDAO目前支持的<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/Operator.java" target="_blank" rel="noopener noreferrer">比较运算符<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>如下表所示。</p> <table><thead><tr><th style="text-align:center;">方法名</th> <th style="text-align:center;"><div style="width:100px;">描述</div></th> <th style="text-align:center;"><div style="width:440px;">示例</div></th></tr></thead> <tbody><tr><td style="text-align:center;">eq</td> <td style="text-align:center;">判断相等</td> <td style="text-align:center;"><code>criteria.and(&quot;username&quot;).eq(&quot;zhangsan&quot;)</code></td></tr> <tr><td style="text-align:center;">ne</td> <td style="text-align:center;">判断不等</td> <td style="text-align:center;"><code>criteria.and(&quot;username&quot;).ne(&quot;zhangsan&quot;)</code></td></tr> <tr><td style="text-align:center;">gt</td> <td style="text-align:center;">判断大于</td> <td style="text-align:center;"><code>criteria.and(&quot;age&quot;).gt(20)</code></td></tr> <tr><td style="text-align:center;">ge</td> <td style="text-align:center;">判断大于等于</td> <td style="text-align:center;"><code>criteria.and(&quot;age&quot;).ge(21)</code></td></tr> <tr><td style="text-align:center;">lt</td> <td style="text-align:center;">判断小于</td> <td style="text-align:center;"><code>criteria.and(&quot;age&quot;).lt(30)</code></td></tr> <tr><td style="text-align:center;">le</td> <td style="text-align:center;">判断小于等于</td> <td style="text-align:center;"><code>criteria.and(&quot;age&quot;).le(29)</code></td></tr> <tr><td style="text-align:center;">contain</td> <td style="text-align:center;">判断包含指定字符串</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).contain(&quot;@qq&quot;)</code></td></tr> <tr><td style="text-align:center;">notContain</td> <td style="text-align:center;">判断不包含指定字符串</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).notContain(&quot;@qq&quot;)</code></td></tr> <tr><td style="text-align:center;">startWith</td> <td style="text-align:center;">判断以指定字符串开始</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).startWith(&quot;zhangsan&quot;)</code></td></tr> <tr><td style="text-align:center;">notStartWith</td> <td style="text-align:center;">判断不以指定字符串开始</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).notStartWith(&quot;zhangsan&quot;)</code></td></tr> <tr><td style="text-align:center;">endWith</td> <td style="text-align:center;">判断以指定字符串结束</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).endWith(&quot;@qq.com&quot;)</code></td></tr> <tr><td style="text-align:center;">notEndWith</td> <td style="text-align:center;">判断不以指定字符串结束</td> <td style="text-align:center;"><code>criteria.and(&quot;email&quot;).notEndWith(&quot;@qq.com&quot;)</code></td></tr> <tr><td style="text-align:center;">in</td> <td style="text-align:center;">判断包含于集合或数组中</td> <td style="text-align:center;"><code>criteria.and(&quot;id&quot;).in(Arrays.asList(1L, 2L))</code></td></tr> <tr><td style="text-align:center;">notIn</td> <td style="text-align:center;">判断不包含于集合或数组中</td> <td style="text-align:center;"><code>criteria.and(&quot;id&quot;).notIn(Arrays.asList(1L, 2L))</code></td></tr> <tr><td style="text-align:center;">isNull</td> <td style="text-align:center;">判断为空</td> <td style="text-align:center;"><code>criteria.and(&quot;username&quot;).isNull()</code></td></tr> <tr><td style="text-align:center;">isNotNull</td> <td style="text-align:center;">判断不为空</td> <td style="text-align:center;"><code>criteria.and(&quot;username&quot;).isNotNull()</code></td></tr></tbody></table> <h2 id="使用数据库函数"><a href="#使用数据库函数" class="header-anchor">#</a> 使用数据库函数</h2> <p>当使用字符串指定字段时，可以在构造<code>SELECT</code>、<code>WHERE</code>、<code>HAVING</code>的过程中使用任意的数据库函数。</p> <p>在使用lambda表达式指定字段的方式时，QuickDAO提供了<code>selectExpr</code>、<code>andExpr</code>、<code>orExpr</code>等方法，用来支持类型安全的数据库函数构造。</p> <p>但是目前的API仅能支持一些常用的函数，如果需要使用API支持范围以外的数据库函数，则只能使用字符串的表达方式。</p> <p>另外，虽然<code>DISTINCT</code>是SQL的关键字，但在API中也被实现成了一种函数。</p> <p>API支持的函数列表如下所示，详情请见<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/SqlFunctionExpression.java" target="_blank" rel="noopener noreferrer">SqlFunctionExpression<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <table><thead><tr><th style="text-align:center;">方法声明</th> <th style="text-align:center;">入参</th> <th style="text-align:center;">功能描述</th></tr></thead> <tbody><tr><td style="text-align:center;">distinct</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算去重后的内容</td></tr> <tr><td style="text-align:center;">countDistinct</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算去重后的数量</td></tr> <tr><td style="text-align:center;">concat</td> <td style="text-align:center;">String... 或 Function...</td> <td style="text-align:center;">连接字符串</td></tr> <tr><td style="text-align:center;">count</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算数量</td></tr> <tr><td style="text-align:center;">max</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算最大值</td></tr> <tr><td style="text-align:center;">min</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算最小值</td></tr> <tr><td style="text-align:center;">avg</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算平均值</td></tr> <tr><td style="text-align:center;">sum</td> <td style="text-align:center;">String 或 Function</td> <td style="text-align:center;">计算总和</td></tr></tbody></table> <p>使用字符串指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">&quot;avg(`age`) AS 'age'&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Criteria</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token string">&quot;min(`age`)&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>使用lambda表达式指定字段的方式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">selectExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span>criteria <span class="token operator">-&gt;</span> criteria<span class="token punctuation">.</span><span class="token function">andExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getAge</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>也可以混合使用字符串和lambda表达式</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">new</span> <span class="token class-name">TypedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token operator">::</span><span class="token function">getGender</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">selectExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">having</span><span class="token punctuation">(</span>criteria <span class="token operator">-&gt;</span> criteria<span class="token punctuation">.</span><span class="token function">andExpr</span><span class="token punctuation">(</span>expr <span class="token operator">-&gt;</span> expr<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">&quot;gender&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="如何处理枚举"><a href="#如何处理枚举" class="header-anchor">#</a> 如何处理枚举</h2> <p>ORM框架（如Spring JDBC、Mybatis等）在处理枚举类型的字段时，一般会将枚举的name或者ordinal值写入数据库，但是这种处理方式可能无法完全满足开发的需求。</p> <p>例如用varchar类型保存枚举字段可能在存储效率上不够理想，而存储ordinal的值，则会导致枚举的值与他们在枚举类中声明的顺序强绑定。</p> <p>因此，一些团队会为每个枚举类显式的声明一个value字段，然后在用于数据持久化的实体类中，使用Integer类型的字段替换枚举字段。这种方式能够避免上述提到的问题，但是在编写代码时（例如赋值或者比较的逻辑），会涉及各种枚举字段与整数的转换，不仅丧失了使用枚举的可读性和安全性，同时增加了代码的繁琐性，以及引入了转换错误的潜在风险。</p> <p>所以有没有既能在实体类中直接声明和使用枚举类型的字段，又能使用枚举中显式声明的value值来进行数据存储的方式呢？<br></p> <p>为此，QuickDAO中提供了<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/IEnum.java" target="_blank" rel="noopener noreferrer">IEnum<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>接口。当一个枚举类实现了<code>IEnum</code>接口中的<code>getValue</code>方法后，数据持久化和查询的过程中，QuickDAO就会自动完成实体中该枚举类的字段与value值之间的转换。这里<code>IEnum</code>的<code>getValue</code>方法返回的不一定需要是整数，也可以是字符串或者其他类型，返回类型由实现<code>IEnum</code>接口时声明的泛型决定。</p> <p>以<code>User</code>实体类中的<code>Gender</code>枚举为例，给出如下的枚举实现。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">Gender</span> <span class="token keyword">implements</span> <span class="token class-name">IEnum</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Gender</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token function">MALE</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token function">FEMALE</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Integer</span> value<span class="token punctuation">;</span>

    <span class="token class-name">Gender</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h2 id="逻辑删除的实现"><a href="#逻辑删除的实现" class="header-anchor">#</a> 逻辑删除的实现</h2> <p>一些团队在开发项目过程中习惯使用逻辑删除（Soft Delete）来替代物理删除（Hard Delete）操作，也就是使用类似<code>is_deleted</code>的字段来标记数据是否被删除。</p> <p>这种做法可以带来一些好处，比如在发生误删除时可以比较容易的找回数据，同时已删除的数据在商业分析和审计等层面可能也存在一定价值。</p> <p>但是，逻辑删除的缺点也很明显，例如所有的查询操作都要携带<code>is_deleted = false</code>的条件，同时所有的删除操作都要按修改操作来实现。如果这些针对逻辑删除的细节都在应用程序中实现，则会给代码的编写和维护带来额外的复杂度，同时一旦开发人员在某处遗漏了对逻辑删除标识的判断，就会引发bug。</p> <p>从本质上讲，应用程序的业务逻辑不应感知数据的持久化操作到底是物理删除还是逻辑删除，这就要求数据持久化框架能够统一的抽象并支持切换物理删除和逻辑删除的相关操作。</p> <p>QuickDAO从这一观点出发，扩展出了<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-core/src/main/java/io/github/yangziwen/quickdao/core/BaseSoftDeletedRepository.java" target="_blank" rel="noopener noreferrer">BaseSoftDeletedRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的各种实现，对外暴露了统一的增删改查API，很好的屏蔽了逻辑删除的实现细节。以下将以<a href="https://github.com/yangziwen/quick-dao/blob/master/quick-dao-spring-jdbc/src/main/java/io/github/yangziwen/quickdao/springjdbc/BaseSoftDeletedSpringJdbcRepository.java" target="_blank" rel="noopener noreferrer">BaseSoftDeletedSpringJdbcRepository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>为例，来说明逻辑删除的实现方法。</p> <p>首先是表结构的声明，需要声明逻辑删除标识字段<code>is_deleted</code>及其<strong>默认值</strong>。</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>user<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
    <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">BIGINT</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>username<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>email<span class="token punctuation">`</span></span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>gender<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>age<span class="token punctuation">`</span></span> <span class="token keyword">INT</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">DATETIME</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>is_deleted<span class="token punctuation">`</span></span> <span class="token keyword">TINYINT</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>之后是声明数据实体类。需要注意的是，业务代码并不关心删除操作是否为逻辑删除，因此实体类中也不应声明<code>is_deleted</code>对应的成员变量，插入数据时也不会指定<code>is_deleted</code>字段的值，这也是声明表结构时一定要为<code>is_deleted</code>字段声明默认值的原因。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@Column</span>
    <span class="token annotation punctuation">@GeneratedValue</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> username<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> email<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">Gender</span> gender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Column</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> age<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>最后按如下方式声明数据实体类对应的数据访问类，即可实现逻辑删除功能。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserRepository</span> <span class="token keyword">extends</span> <span class="token class-name">BaseSoftDeletedSpringJdbcRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">UserSoftDeletedSpringJdbcRepository</span><span class="token punctuation">(</span><span class="token class-name">JdbcTemplate</span> jdbcTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>jdbcTemplate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 逻辑删除的标识字段（不需要在entity中声明）
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDeletedFlagColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;is_deleted&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 已删除数据的逻辑删除标识字段值
     * 对于`is_deleted`字段，true表示已删除
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getDeletedFlagValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 未删除数据的逻辑删除标识字段值
     * 对于`is_deleted`字段，false表示未删除
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getNotDeletedFlagValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 数据表中的更新时间字段，返回空则逻辑删除时忽略更新时间
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUpdateTimeColumn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;update_time&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 数据表中更新时间字段的取值，返回空则逻辑删除时忽略更新时间
     * 只能返回new Date().getTime() 或 &quot;now()&quot;，不能返回Date对象
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getUpdateTimeValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;now()&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>通常情况下，一个项目中所有数据表的逻辑删除标识字段名称以及取值应是统一的，因此在项目范围内可实现一个继承了<code>BaseSoftDeletedSpringJdbcRepository</code>的抽象类，对逻辑删除标识字段和更新时间字段作统一声明。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/quick-dao/start/" class="prev">
        快速开始
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/quick-dao/assets/js/app.ad0dd564.js" defer></script><script src="/quick-dao/assets/js/2.cfc2b85d.js" defer></script><script src="/quick-dao/assets/js/8.1fd11c31.js" defer></script>
  </body>
</html>
